<!doctype html>
<html>
  <head>
    <title>Wasm Chess</title>
    <script defer src="chess.js"></script>
  </head>
  <body style="background-color: gray;">
    <div style="text-align: center;">
        <noscript> Your browser doesn't support JavaScript. Apperently it's 1995 where you live. </noscript>
        <canvas id="board" style="background:url(assets/board.svg); width: 90%; max-width: 500px;"> Your browser doesn't support canvas. Apperently it's 2004 where you live. </canvas>
        <div id="loading"> Loading... </div>
        <div id="controls">
           <div style="font-size: 2rem;" id="player"></div>
            <button onclick="handleAskRestart()"> Reset Board </button>
            <button onclick="handlePause()" id="pause" disabled> Pause </button>
            <button onclick="handleResume()" id="resume"> Resume </button>
            <br> <br>
            FEN: <input type="text" id="fen" style="width: 350px;"> <button onclick="handleSetFromFen()">Set Board</button> <br>
            Info: <select id="bitboard" onchange="handleBitboardSelect()">
                <option value="none">None</option>
                <option value="all">All Piece Positions</option>
                <option value="king">King Position</option>
                <option value="castle">Castling Rights</option>
                <option value="french" selected>En Passant Target</option>
                <option value="prev" selected>Last Move</option>
            </select>
            Material Eval: <span id="mEval"></span>.
        </div>
    </div>
    <pre id="letters"></pre>
  <script>
    const startTime = performance.now();
    var wasmReady = false;
    function startChessIfReady() {
        // This get's called each time something loads. Wait until everything is loaded...
        if (!wasmReady || window.chessJsReady === undefined || !chessImg.complete) return;

        document.getElementById("loading").style.display = "none";
        handleResize();
        document.getElementById("board").addEventListener("click", handleCanvasClick);
        addEventListener("resize", handleResize);
        handleRestart();
        handleBitboardSelect();
        renderBoard();
    }

    var Engine;
    function handleWasmLoaded(wasm) {
        console.log("WASM ready in " + Math.round(performance.now() - startTime) + "ms.");
        Engine = wasm.instance.exports;
        wasmReady = true;
        window.startChessIfReady();
    }
    const callbacks = { 
        env: {
            jsConsoleLog: function (ptr, len) {
                const msgBuffer = new Uint8Array(Engine.memory.buffer, ptr, len);
                const msgStr = textDecoder.decode(msgBuffer);
                console.log(msgStr);
            },
            jsAlert: function (ptr, len) {
                const msgBuffer = new Uint8Array(Engine.memory.buffer, ptr, len);
                const msgStr = textDecoder.decode(msgBuffer);
                alert(msgStr);
            }
        }
    }
    if (typeof WebAssembly === "object" && WebAssembly.instantiateStreaming !== undefined) {
        WebAssembly.instantiateStreaming(fetch("main.wasm"), callbacks).then(handleWasmLoaded);
    } else {
        document.getElementById("controls").style.display = "none";
        document.getElementById("loading").innerText = "Your browser doesn't support WASM. Apperently it's 2015 where you live.";
    }
    
    const chessImg = new Image();
    chessImg.src = "assets/pieces.svg";
    chessImg.onload = window.startChessIfReady;
  </script>
  </body>
</html>
