<!doctype html>
<html>
  <head>
    <title>Wasm Chess</title>
    <script defer src="chess.js"></script>
  </head>
  <body style="background-color: gray;">
    <div style="text-align: center;">
        <canvas id="board" style="background:url(assets/board.svg); width: 30%;"> Your browser doesn't support canvas. Apperently it's 2004 where you live. </canvas>
        <div id="controls">
            <button onclick="handleRestart()"> Reset Board </button>
            <button onclick="handlePause()" id="pause" disabled> Pause </button>
            <button onclick="handleResume()" id="resume"> Resume </button>
            <br> <br>
            FEN: <input type="text" id="fen" style="width: 350px;"> <button onclick="handleSetFromFen()">Set Board</button> <br>
            <span id="player"></span>'s Turn. Material Eval: <span id="mEval"></span> <br>
            <select id="bitboard" onchange="handleBitboardSelect()">
                <option value="none" selected>None</option>
                <option value="all">All Piece Positions</option>
                <option value="king">King Position</option>
                <option value="castle">Castling Rights</option>
            </select>
        </div>
        <div id="loading"> Loading... </div>
    </div>
    <pre id="letters"></pre>
  <script>
    var wasmReady = false;
    function startChessIfReady() {
        // This get's called each time something loads. Wait until everything is loaded...
        if (!wasmReady || window.chessJsReady === undefined || !chessImg.complete) return;

        document.getElementById("loading").style.display = "none";
        ctx.canvas.addEventListener("click", handleCanvasClick);
        handleRestart();
        handleBitboardSelect();
        renderBoard();
    }

    var Engine;
    function handleWasmLoaded(wasm) {
        Engine = wasm.instance.exports;
        wasmReady = true;
        window.startChessIfReady();
    }
    if (typeof WebAssembly === "object") {
        WebAssembly.instantiateStreaming(fetch("main.wasm"), {}).then(handleWasmLoaded);
    } else {
        document.getElementById("controls").style.display = "none";
        document.getElementById("loading").innerText = "Your browser doesn't support WASM. Apperently it's 2015 where you live.";
    }
    
    const chessImg = new Image();
    chessImg.src = "assets/pieces.svg";
    chessImg.onload = window.startChessIfReady;
    const ctx = document.getElementById("board").getContext("2d");

    {
        let boardWidth = document.getElementById("board").width;
        document.getElementById("board").height = boardWidth;
    }

    // TODO: put this in build.zig
    // zig build-lib src/web.zig -target wasm32-freestanding -dynamic -rdynamic -O ReleaseFast && mv web.wasm web/main.wasm
  </script>
  </body>
</html>
