<!doctype html>
<html>
  <head>
    <title>Wasm Chess</title>
    <script defer src="chess.js"></script>
  </head>
  <body style="background-color: gray;">
    <div style="text-align: center;">
        <canvas id="board" style="background:url(assets/board.svg); width: 30%;"> why do you no are have canvas?! </canvas>
        <div id="controls">
            <button onclick="handleRestart()"> Reset Board </button>
            <button onclick="handlePause()" id="pause" disabled> Pause </button>
            <button onclick="handleResume()" id="resume"> Resume </button>
            <br> <br>
            FEN: <input type="text" id="fen" style="width: 350px;"> <button onclick="handleSetFromFen()">Set Board</button>
        </div>
        <div id="loading"> Loading... </div>
    </div>
    <pre id="letters"></pre>
  <script>
    var wasmReady = false;
    function startChessIfReady() {
        // This get's called each time something loads. Wait until everything is loaded...
        if (!wasmReady || window.chessJsReady === undefined || !chessImg.complete) return;

        document.getElementById("loading").style.display = "none";
        ctx.canvas.addEventListener("click", handleCanvasClick);
        renderBoard();
    }

    var Engine;
    var ticker = null;
    WebAssembly.instantiateStreaming(fetch("main.wasm"), {}).then(
        (result) => {
            console.log(result.instance.exports);
            Engine = result.instance.exports;
            Engine.restartGame();
            wasmReady = true;
            window.startChessIfReady();
        }
    );

    const textEncoder = new TextEncoder();
    const textDecoder = new TextDecoder();
    const chessImg = new Image();
    chessImg.src = "assets/pieces.svg";
    chessImg.onload = window.startChessIfReady;
    const ctx = document.getElementById("board").getContext("2d");
    var clicked = null;

    {
        let boardWidth = document.getElementById("board").width;
        if (document.getElementById("board").height != boardWidth){
            document.getElementById("board").height = boardWidth;
        }
    }

    // TODO: put this in build.zig
    // zig build-lib src/web.zig -target wasm32-freestanding -dynamic -rdynamic -O ReleaseFast && mv web.wasm web/main.wasm
  </script>
  </body>
</html>
