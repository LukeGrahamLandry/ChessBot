<!doctype html>
<html>
  <head>
    <title>Wasm Chess</title>
  </head>
  <body style="background-color: gray;">
    <div style="text-align: center;">
        <canvas id="board" style="background:url(assets/board.svg); width: 30%;"> why do you no are have canvas?! </canvas> <br>
        <button onclick="handleRestart()"> Reset Board </button>
    </div>
    <pre id="letters"></pre>
  </body>
  <!-- TODO: put this in seperate js file? But I don't want it to wait for the js to load before downloading the wasm. -->
  <script>
    let boardWidth = document.getElementById("board").width;
    if (document.getElementById("board").height != boardWidth){
        document.getElementById("board").height = boardWidth;
    }
    
    const pieces = pieceArray();
    let Engine;
    WebAssembly.instantiateStreaming(fetch("main.wasm"), {}).then(
        (result) => {
            console.log(result.instance.exports);
            Engine = result.instance.exports;
            if (!chessImg.complete){
                document.getElementById("letters").innerText += "WASM ready but pieces image not loaded yet.\n";
            }
            Engine.restartGame();
            renderBoard();
            tickGame();
        }
    );
    function tickGame() {
        window.setTimeout(function() {
            let result = Engine.playNextMove();
            renderBoard();
            let msg;
            switch (result) {
                case 0:
                    tickGame();
                    return;
                case 1:
                    msg = "Engine reported error.";
                    break;
                case 2:
                    msg = "White cannot move.";
                    break;
                case 3:
                    msg = "Black cannot move.";
                    break;
                default:
                    msg = "Invalid engine response: " + result;
            }
            document.getElementById("letters").innerText += "\n" + msg;
        }, 200);
    };

    function handleRestart() {
        Engine.restartGame();
        renderBoard();
        // TODO: start tickGame running again if the game was over. 
    }

    const chessImg = new Image();
    chessImg.src = "assets/pieces.svg";  // TODO: wait for on load? 
    const ctx = document.getElementById("board").getContext("2d");

    function drawPiece(file, rank, pieceByte) {
        if (pieceByte == 0) return;

        let squareSize = boardWidth / 8;
        let imgSquareSize = chessImg.width / 6;
        let offset = pieces[pieceByte];
        if (offset === undefined) {
            console.log("Engine gave invalid pieceByte (" + pieceByte + ")");
            return;
        }
        let sX = offset * imgSquareSize;
        let sY = 0;
        if (pieceByte % 2 == 1){
            sY = imgSquareSize;
        }
        ctx.drawImage(chessImg, sX, sY, imgSquareSize, imgSquareSize, file * squareSize, (7 - rank) * squareSize, squareSize, squareSize);
    }

    function renderBoard() {
        let board = new Uint8Array(Engine.memory.buffer, Engine.theBoard);
        // TODO: If I really cared I could just render the diff instead of clearing the board
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        for (let rank=0;rank<8;rank++){
            for (let file=0;file<8;file++){
                const p = board[rank*8 + file];
                drawPiece(file, rank, p);
            }
        }
    }

    // TODO: these should be done in drawPiece with (b & flag)
    function pieceArray() {
        // These are the indexes of each type of piece in the pieces.svg image.
        const piecesMap = {
            5: 5,
            6: 5,
            9: 2,
            10: 2,
            13: 3,
            14: 3,
            17: 4,
            18: 4,
            21: 1,
            22: 1,
            25: 0,
            26: 0,
        };
        const pieces = new Array(26);
        for (let i = 0; i<27;i++) {
            let c = piecesMap[i];
            if (c != undefined) {
                pieces[i] = c;
            }
        }
        return pieces
    }

    // TODO: put this in build.zig
    // zig build-lib src/web.zig -target wasm32-freestanding -dynamic -rdynamic -O ReleaseFast && mv web.wasm web/main.wasm
  </script>
</html>
