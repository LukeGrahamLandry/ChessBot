<!doctype html>
<html>
  <head>
    <title>Wasm Chess</title>
  </head>
  <body>
    <!-- <canvas id="board" width="100" height="100"> why do you no are have canvas?! </canvas> <br>  -->
    <pre id="letters"></pre>
  </body>
  <script>
    const pieces = pieceArray();
    let Engine;
    WebAssembly.instantiateStreaming(fetch("main.wasm"), {}).then(
        (result) => {
            console.log(result.instance.exports);
            Engine = result.instance.exports;
            document.getElementById("letters").innerText = getBoardString();
            const run = () => window.setTimeout(function() {
                if (Engine.playNextMove()) {
                    run();
                }
                document.getElementById("letters").innerText = getBoardString();
            }, 800);
            run();
        },
    );

    function getBoardString() {
        let board = new Uint8Array(Engine.memory.buffer, Engine.theBoard);
        let lines = new Array(8);
        for (let i=0;i<8;i++){
            let x = new Array(8);
            for (let j=0;j<8;j++){
                const p = board[i*8 + j];
                if (p > pieces.length) {
                    x[j] = "?";
                } else {
                    x[j] = pieces[p];
                }
            }
            lines[i] = x.join(' ');
        }
        return lines.join("\n");
    }

    function pieceArray() {
        const piecesMap = {
            0: " ",
            5: "P",
            6: "p",
            9: "B",
            10: "b",
            13: "N",
            14: "n",
            17: "R",
            18: "r",
            21: "Q",
            22: "q",
            25: "K",
            26: "k",
        };
        const pieces = new Array(26);
        for (let i = 0; i<27;i++) {
            let c = piecesMap[i];
            if (c == undefined) {
                pieces[i] = '?';
            } else {
                pieces[i] = c;
            }
        }
        return pieces
    }

    // zig build-lib src/web.zig -target wasm32-freestanding -dynamic -rdynamic -O ReleaseFast && mv web.wasm web/main.wasm
  </script>
</html>
